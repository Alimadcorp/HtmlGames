<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #121212;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <script>
      let birds = [],
        floorNumbers = [],
        inputText = "";
      const gravity = 0.5,
        maxHits = 3,
        birdLifetime = 10000;
      const bgColor = [18, 18, 18],
        floorColor = [0, 0, 0],
        birdColor = [229, 57, 53];
      let dragging = false,
        slingshot;

      function setup() {
        createCanvas(windowWidth, windowHeight);
        slingshot = createVector(150, height - 150);
        birds.push(new Bird(slingshot.x, slingshot.y));
        generateFloor();
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        generateFloor();
      }

      function draw() {
        background(bgColor);
        drawFloor();
        drawPrediction();
        birds.forEach((b) => {
          b.update();
          b.show();
        });
        fill(255);
        textSize(24);
        textAlign(LEFT, TOP);
        text("Input: " + inputText, 10, 10);
      }

      function mousePressed() {
        let b = birds[birds.length - 1];
        if (dist(mouseX, mouseY, b.pos.x, b.pos.y) < b.r) dragging = true;
      }

      function mouseReleased() {
        if (dragging) {
          dragging = false;
          let b = birds[birds.length - 1];
          b.fly(createVector(mouseX, mouseY));
          birds.push(new Bird(slingshot.x, slingshot.y));
        }
      }

      function keyPressed() {
        if (key === "Backspace") inputText = inputText.slice(0, -1);
      }

      function generateFloor() {
        floorNumbers = [];
        let startX = width * 0.2,
          w = (width * 0.8) / 10;
        floorNumbers.push({ x: startX - w, w, n: "+", glow: 0 });
        for (let i = 0; i < 10; i++)
          floorNumbers.push({ x: startX + i * w, w, n: i, glow: 0 });
      }

      function drawFloor() {
        const h = 50;
        floorNumbers.forEach((f) => {
          fill(
            f.glow > 0 ? color(255, 255, 0, (f.glow = f.glow - 5)) : floorColor
          );
          rect(f.x, height - h, f.w, h);
          fill(255);
          textAlign(CENTER, CENTER);
          textSize(25);
          text(f.n, f.x + f.w / 2, height - h / 2);
        });
      }

      function drawPrediction() {
        if (!dragging) return;
        let pos = slingshot.copy();
        let vel = p5.Vector.sub(slingshot, createVector(mouseX, mouseY)).mult(
          0.15
        );
        strokeWeight(2);
        noFill();
        for (let t = 0; t < 100; t += 5) {
          vel.y += gravity;
          pos.add(vel.copy());
          stroke(255, 255, 0, map(t, 0, 100, 255, 0));
          ellipse(pos.x, pos.y, 5);
        }
      }

      class Bird {
        constructor(x, y) {
          this.pos = createVector(x, y);
          this.r = 20;
          this.vel = createVector();
          this.flying = false;
          this.hidden = false;
          this.hits = 0;
        }
        fly(target) {
          this.vel = p5.Vector.sub(slingshot, target).mult(0.15);
          this.flying = true;
        }
        update() {
          if (dragging && this === birds[birds.length - 1])
            this.pos.set(mouseX, mouseY);
          else if (this.flying) {
            this.vel.y += gravity;
            this.pos.add(this.vel);
            if (this.pos.x - this.r < 0 || this.pos.x + this.r > width)
              this.vel.x *= -1;
            if (this.pos.y - this.r < 0) this.vel.y *= -1;
            const h = 50;
            if (this.pos.y + this.r > height - h) {
              this.pos.y = height - h - this.r;
              this.vel.y *= -0.7;
              this.vel.x *= 0.7;
              for (let f of floorNumbers)
                if (
                  this.pos.x > f.x &&
                  this.pos.x < f.x + f.w &&
                  this.hits < maxHits
                ) {
                  inputText += f.n;
                  f.glow = 255;
                  this.hits++;
                  break;
                }
            }
            this.r *= 0.995;
            if (this.r < 1) this.hidden = true;
          }
        }
        show() {
          if (this.hidden) return;
          fill(birdColor);
          noStroke();
          ellipse(this.pos.x, this.pos.y, this.r * 2);
        }
      }
    </script>
  </body>
</html>
